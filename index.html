<html>

<!--

     Arkanon <arkanon@lsd.org.br>
     2013/09/27 (Sex) 23:35:51 (BRS)
     2013/09/22 (Sun) 17:53:49 (BRS)
     2013/09/20 (Sex) 08:33:53 (BRS)
     2013/09/17 (Tue) 21:59:40 (BRS)
     2013/09/17 (Tue) 05:38:31 (BRS)
     2013/09/15 (Sun) 21:35:32 (BRS)
     2013/09/11 (Wed) 04:37:28 (BRS)
     2013/09/07 (Sat) 06:40:39 (BRS)
     2013/09/02 (Seg) 06:24:05 (BRS)
     2013/09/01 (Sun) 21:09:33 (BRS)

     <http://en.wikipedia.org/wiki/Sierpinski_triangle>
     <http://math.bu.edu/DYSYS/chaos-game/node1.html>

-->

<head>

  <title>Chaos Game</title>

  <meta charset="utf-8">

  <link href='http://fonts.googleapis.com/css?family=Ubuntu' rel='stylesheet' type='text/css' />

  <style>

    *
    {
      font-family: Ubuntu;
      font-size: 10pt;
      -webkit-touch-callout: none;
        -webkit-user-select: none;
         -khtml-user-select: none;
           -moz-user-select: none;
            -ms-user-select: none;
                user-select: none;
    }

    #fator
    {
      -webkit-touch-callout: auto;
        -webkit-user-select: auto;
         -khtml-user-select: auto;
           -moz-user-select: auto;
            -ms-user-select: auto;
                user-select: auto;
    }

    body
    {
      height: 100%;
      margin: 5px;
      background: #444;
    }

    #controle
    {
      display: inline-block;
      margin: 0 0 4px 0;
    }

    #canvases
    {
      display: inline-block;
      position: relative;
      background-color: black;
      vertical-align: top;
    }

    canvas
    {
      position: absolute;
    }

    #realtime
    {
      display: inline-block;
    }

    #tamanho
    {
      text-align: center;
    }

    #sobre,
    #tamanho,
    #N,
    #fator,
    #rastro,
    #intmeth,
    #plotmeth,
    #estado,
    #salvar,
    #outro
    {
      display: block;
      width: 95px;
    }

    #demonst,
    #inicio,
    #agora,
    #tempot
    {
      width: 170px;
    }

    #controle>span,
    #realtime>span
    {
      position: relative;
      display: block;
      width: 87px;
    }

    #controle>span>input[type=checkbox],
    #realtime>span>input[type=checkbox]
    {
      margin-top: 4px;
      margin-bottom: 1px;
    }

    #controle>span>label,
    #realtime>span>label
    {
      position: absolute;
      top: 1px;
      right: 0;
      left: 18px;
    }

    #controle>span,
    #realtime>span,
    #controle select,
    #controle input,
    #cabecalho
    {
      margin: 0 4px 4px 0;
    }

    #controle #realtime input[type=checkbox].individual
    {
      margin: 0 7px 0 5px;
    }

    #realtime div
    {
      display: block;
    }

    #realtime div .porcentagem
    {
      width: 55px;
    }

    #cabecalho input[type=checkbox]
    {
      vertical-align: middle;
      margin: 3px 0 1px 1px;
    }

    #cabecalho input[type=text]
    {
      margin-bottom: 0;
    }

    #inicio,
    #agora,
    #tempot,
    #cabecalho label
    {
      display: block;
      text-align: center;
    }

    #vm,
    #vi,
    #iter
    {
      vertical-align: bottom;
      margin-bottom: 0;
    }

    span
    {
      vertical-align: top;
      display: inline-block;
      border: 1px solid #7a7a7a;
      background-color: white;
      padding: 0 3px 2px 3px;
    }

    input[type=checkbox]
    {
      vertical-align: middle;
      margin: 0 3px 0 0;
    }

    input[type=button]
    {
      margin: 0;
      padding: 0 3px;
    }

    input[type=text]
    {
      border: 1px solid #7a7a7a;
      text-align: right;
      margin: 0;
      padding: 1px 3px;
      width: 70px;
    }

    input[type=text].vm
    {
      width: 50px;
    }

    input[type=text].vi
    {
      width: 55px;
    }

    input[disabled=disabled]
    {
      color: black;
    }

    select
    {
      margin: 0;
    }



    #sobre,
    #demonst,
    #estado
    {
      color: #ffffff;
      background-color: #fe1a00;
    }

    #sobre:active,
    #demonst:active,
    #estado:active
    {
      background-color: #ce0100;
    }



/*

    #sobre
    {
      color: black;
      background-color: gold;
    }

    #sobre:active
    {
      background-color: goldenrod;
    }

*/



    input[type=button].color
    {
      -webkit-box-shadow: inset 0px 1px 0px 0px #f09393;
         -moz-box-shadow: inset 0px 1px 0px 0px #f09393;
              box-shadow: inset 0px 1px 0px 0px #f09393;
             text-shadow:           1px 1px 0px #b23e35;
      background: -webkit-gradient( linear, left top, left bottom, color-stop(0.05, #fe1a00), color-stop(1, #ce0100) );
      background: -moz-linear-gradient( center top, #fe1a00 5%, #ce0100 100% );
      filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='#fe1a00', endColorstr='#ce0100');
      padding: 1px 0 1px 0;
      border: 1px solid #7a7a7a;
    }

    input[type=button].color:hover
    {
      background: -webkit-gradient( linear, left top, left bottom, color-stop(0.05, #ce0100), color-stop(1, #fe1a00) );
      background: -moz-linear-gradient( center top, #ce0100 5%, #fe1a00 100% );
      filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='#ce0100', endColorstr='#fe1a00');
    }

    input[type=button].color:active
    {
      position: relative;
      top: 1px;
    }

    input[disabled=disabled].color,
    input[disabled=disabled].color:active
    {
      top: 0 !important;
           color: black !important;
      background: #dddddd !important;
      -webkit-box-shadow: none !important;
         -mox-box-shadow: none !important;
              box-shadow: none !important;
             text-shadow: none !important;
    }

  </style>

  <script src="colornames.js"></script>

  <script>

    var sem    = 'white';
    var mon    = 'gray';
    var week   = [ 'Dom', 'Sed' , 'Ter' , 'Qua' , 'Qui' , 'Sex' , 'Sáb' ];
    var cores  = [
                   'red'           , //  1
                   'lime'          , //  2
                   'dodgerblue'    , //  3
                   'chocolate'     , //  4
                   'yellow'        , //  5
                   'magenta'       , //  6
                   'cyan'          , //  7
                   'gray'          , //  8
                   'orangered'     , //  9
                   'salmon'        , // 10
                   'aquamarine'    , // 11
                   'goldenrod'     , // 12
                   'lightpink'     , // 13
                   'darkslateblue' , // 14
                   'green'           // 15

                 ];
    var tags   = [ 'canvas' , 'input' ];
    var views  = [ 'vertex' , 'pontos' , 'discos' , 'linhas' ];
    var modes  = [ 'color' , 'monoc' ];

    var parametros =
    {

      'estado'  : {
                    'Iniciar' : function() { rodar(true) },
                    'Parar'   : function() { parar()     }
                  },

    };

    var visibilidade =
    {
      'semente0'     : 0,
      'sementei'     : 0,
      'semanter'     : 0,
      'crastro'      : 0,
      'vertex-color' : 0,
      'vertex-monoc' : 0,
      'pontos-color' : 1,
      'pontos-monoc' : 0,
      'discos-color' : 0,
      'discos-monoc' : 0,
      'linhas-color' : 0,
      'linhas-monoc' : 0,
    };



    var W, H, pr, natW, natH, enatW, enatH, sc;
    var inicio, reinicio, antes, tempot, semente, semente0, realtime, canvases;
    var valor      = [];
    var canvas     = [];
    var context    = [];
    var pixel      = [];
    var vertices   = [];
    var natO       = [];
    var pi         = Math.PI;
    var colornames = colornames();
    var rodando    = false;
    var offset     = 0;

    var vertraio    =    5;
    var discraio    =    2;
    var linhaesp    =   .2;
    var rastroesp   =    1;
    var rastromax   =   18;
    var rastrodef   =    0;
    var intmethdef  =    1;
    var plotmethdef =    2;
    var delay       = 1000; // milissegundos
    var LT          = [ -250 ,  250 ];
    var RB          = [  250 , -250 ];

    var rastro      =    0;
    var anterior    =    0;



    window.onload = function()
    {

      var metrics, id, i, option;

      metrics = document.body.getBoundingClientRect();
      natW    = metrics.height - 2*metrics.top;

      document.body.style.height = natW;

      W       = RB[0] - LT[0];        // width
      H       = LT[1] - RB[1];        // height

      pr      = H/W;                  // proportion
      sc      = W/natW;               // scale
      natH    = natW*pr;              // native height

      enatW   = 1 + Math.round(natW); // effective native width
      enatH   = 1 + Math.round(natH); // effective native height

      $('tamanho').value = enatW + '×' + enatH + 'px';

      natO[0] = Math.abs(LT[0]/sc);   // native origin x
      natO[1] = Math.abs(LT[1]/sc);   // native origin y

      realtime = $('realtime');
      canvases = $('canvases');

      canvases.style.width  = enatW;
      canvases.style.height = enatH;

      id = 'semente0';
      context[id] = $('canvas-'+id).getContext('2d');
      $('canvas-'+id).width  = enatW;
      $('canvas-'+id).height = enatH;

      for (i=3; i<=cores.length; i++)
      {
        option = document.createElement('option');
        option.innerHTML = i;
        $('N').appendChild(option);
      }

      for (i=1; i<=rastromax; i++)
      {
        option = document.createElement('option');
        option.innerHTML = i;
        $('rastro').appendChild(option);
      }

    }



    function ambiente()
    {

      rodar(false);

      var T, alfa, cor, view, tag, mode;
      var c, v, t, m, N;
      var el, container, div, id, semi, crastro, iter, vm, vi, porc;

      valor['N'] = $('N').value;
      N = valor['N'];

      $('estado').disabled = '';

      while ( realtime.lastChild.id != 'cabecalho'       ) realtime.removeChild(realtime.lastChild);
      while ( canvases.lastChild.id != 'canvas-semente0' ) canvases.removeChild(canvases.lastChild);

      for ( c=0; c<N; c++ )
      {

        cor    = cores[c];

        div    = document.createElement('div');
        div.id = cor;

        for (t in tags)
        {

          tag = tags[t];

          for (v in views)
          {

            view = views[v];

            for (m in modes)
            {

              mode = modes[m];

              id = cor + '-' + view + '-' + mode;
              el = document.createElement(tag);

              switch (tag)
              {

                case ('canvas'):
                  el.id       = tag + '-' + id;
                  el.width    = enatW;
                  el.height   = enatH;
                  context[id] = el.getContext('2d');
                  pixel[id]   = context[id].createImageData(1,1);
                  container   = canvases;
                  break;

                case ('input'):
                  el.setAttribute( 'type' , 'checkbox' );
                  el.id        = id;
                  el.className = 'individual';
                  el.onclick   = function(){ set('vis',this) };
                  container    = div;
                  break;

              }

              container.appendChild(el);

            }

          }

        }

        iter                       = document.createElement('input');
        iter.id                    = cor + '-iter';
        iter.value                 = 0;
        iter.style.backgroundColor = cor;
        iter.setAttribute('type'    , 'text'    );
        iter.setAttribute('disabled', 'disabled');
        div.appendChild(iter);

        vm                       = document.createElement('input');
        vm.id                    = cor + '-vm';
        vm.className             = 'vm';
        vm.value                 = 0;
        vm.style.backgroundColor = cor;
        vm.setAttribute('type'    , 'text'    );
        vm.setAttribute('disabled', 'disabled');
        div.appendChild(vm);

        vi                       = document.createElement('input');
        vi.id                    = cor + '-vi';
        vi.className             = 'vi';
        vi.value                 = 0;
        vi.style.backgroundColor = cor;
        vi.setAttribute('type'    , 'text'    );
        vi.setAttribute('disabled', 'disabled');
        div.appendChild(vi);

        porc                       = document.createElement('input');
        porc.id                    = cor + '-porc';
        porc.className             = 'porcentagem';
        porc.value                 = '0%';
        porc.style.backgroundColor = cor;
        porc.setAttribute('type'    , 'text'    );
        porc.setAttribute('disabled', 'disabled');
        div.appendChild(porc);

        realtime.appendChild(div );

        angulo      = pi/2 - 2*pi*c/N;
        apotema     =  H/2 - vertraio - 3;
        vertices[c] = [ apotema*cos(angulo), apotema*sen(angulo) ];
        disco( cor + '-vertex-color' , vertices[c][0] , vertices[c][1] , vertraio , cor );
        disco( cor + '-vertex-monoc' , vertices[c][0] , vertices[c][1] , vertraio , mon );

      }

      $('iter').value = 0;
      $('vm'  ).value = 0;
      $('vi'  ).value = 0;

      semente0 = [ rnd(W) + LT[0] , rnd(H) + RB[1] ];
      semente  = [ semente0 ];

      id = 'semente0';
      context[id].clearRect(0,0,enatW,enatH);
      disco( id , semente0[0] , semente0[1] , vertraio , sem );
      sem0                    = $('canvas-'+id);
      if (!rodando)
      {
        $(id).checked             = visibilidade[id];
        sem0.style.visibility     = visibilidade[id] ? 'visible' : 'hidden';
      }

      id                          = 'sementei';
      semi                        = document.createElement('canvas');
      semi.id                     = 'canvas-' + id;
      semi.width                  = enatW;
      semi.height                 = enatH;
      semi.onclick                = function(){ set('vis',this) };
      context[id]                 = semi.getContext('2d');
      if (!rodando)
      {
        $(id).checked             = visibilidade[id];
        semi.style.visibility     = visibilidade[id] ? 'visible' : 'hidden';
      }
      canvases.appendChild(semi);

      id                          = 'crastro';
      crastro                     = document.createElement('canvas');
      crastro.id                  = 'canvas-' + id;
      crastro.width               = enatW;
      crastro.height              = enatH;
      crastro.onclick             = function(){ set('vis',this) };
      context[id]                 = crastro.getContext('2d');
      if (!rodando)
      {
        $(id).checked             = visibilidade[id];
        crastro.style.visibility  = visibilidade[id] ? 'visible' : 'hidden';
      }
      canvases.appendChild(crastro);

      id                          = 'semanter';
      semanter                    = document.createElement('canvas');
      semanter.id                 = 'canvas-' + id;
      semanter.width              = enatW;
      semanter.height             = enatH;
      semanter.onclick            = function(){ set('vis',this) };
      context[id]                 = semanter.getContext('2d');
      if (!rodando)
      {
        $(id).checked             = visibilidade[id];
        semanter.style.visibility = visibilidade[id] ? 'visible' : 'hidden';
      }
      canvases.appendChild(semanter);

      if (!rodando)
      {

        T    = 1 + int(N/4);
        alfa = 2*pi/N;

        valor['fator']   = 1 - sqr( (1-cos(alfa))/(1-cos(T*alfa)) ) / (2*cos((T-1)*alfa/2));
        $('fator').value = valor['fator'].toFixed(7);

        $('rastro'  ).getElementsByTagName('option')[rastrodef  ].selected = 'selected';
        $('intmeth' ).getElementsByTagName('option')[intmethdef ].selected = 'selected';
        $('plotmeth').getElementsByTagName('option')[plotmethdef].selected = 'selected';

      }

      for (v in views)
        for (m in modes)
        {
          id = views[v] + '-' + modes[m];
          if (!rodando) $(id).checked = visibilidade[id];
          set('all', $(id));
        }

    }



    function mainloop()
    {

      var N        = valor['N'];
      var fator    = valor['fator'];
      var rastro   = int($('rastro'  ).value);
      var intmeth  = int($('intmeth' ).value);
      var tempoi;

      if (rodando)
      {

        var c       = int((rnd(N)))%N;
        var cor     = cores[c];
        var rastroi = (anterior+1)%(rastro+1);

        if ( semente[anterior] !== undefined )
             semente[rastroi ]   = [
                                     semente[anterior][0] + ( vertices[c][0] - semente[anterior][0] ) * fator ,
                                     semente[anterior][1] + ( vertices[c][1] - semente[anterior][1] ) * fator
                                   ];

        context['sementei'].clearRect(0,0,enatW,enatH);
        context['semanter'].clearRect(0,0,enatW,enatH);
        context['crastro' ].clearRect(0,0,enatW,enatH);

        for ( var i=0; i<rastro; i++ )
            if (
                 semente[(rastro+rastroi-i  )%(rastro+1)] !== undefined &&
                 semente[(rastro+rastroi-i+1)%(rastro+1)] !== undefined
               )
            {

               disco
               (
                 'semanter' ,
                 semente[(rastro+rastroi-i  )%(rastro+1)][0] ,
                 semente[(rastro+rastroi-i  )%(rastro+1)][1] ,
                 discraio ,
                 sem
               );

               linha
               (
                 'crastro' ,
                 semente[(rastro+rastroi-i  )%(rastro+1)][0] ,
                 semente[(rastro+rastroi-i  )%(rastro+1)][1] ,
                 semente[(rastro+rastroi-i+1)%(rastro+1)][0] ,
                 semente[(rastro+rastroi-i+1)%(rastro+1)][1] ,
                 rastroesp ,
                 sem
               );

            }

        if ( semente[rastroi] !== undefined )
        {
          disco( 'sementei' , semente[rastroi][0] , semente[rastroi][1] , vertraio , sem );
          ponto( cor + '-pontos-color' , semente[rastroi ][0] , semente[rastroi ][1] ,            cor );
          ponto( cor + '-pontos-monoc' , semente[rastroi ][0] , semente[rastroi ][1] ,            mon );
          disco( cor + '-discos-color' , semente[rastroi ][0] , semente[rastroi ][1] , discraio , cor );
          disco( cor + '-discos-monoc' , semente[rastroi ][0] , semente[rastroi ][1] , discraio , mon );
        }

        if ( semente[anterior] !== undefined )
        {
          linha( cor + '-linhas-color' , semente[anterior][0] , semente[anterior][1] , semente[rastroi][0] , semente[rastroi][1] , linhaesp , cor );
          linha( cor + '-linhas-monoc' , semente[anterior][0] , semente[anterior][1] , semente[rastroi][0] , semente[rastroi][1] , linhaesp , mon );
        }

        anterior = rastroi;

        $(     'iter').value ++;
        $(cor+'-iter').value ++;

        var agora = new Date();
        $('agora').value = agora.date();
        tempot = offset + ( agora.getTime() - reinicio.getTime() ) / 1000;
        if ( antes !== undefined )
        tempoi =          ( agora.getTime() -    antes.getTime() ) / 1000;

        ms = String(tempot.toFixed(3)).split('.')[1];
        ts = int(tempot);
        s  = (ts%60).zpad();
        ts = int(ts/60);
        m  = (ts%60).zpad();
        h  = (int(ts/60)).zpad();
        $(  'tempot').value = h + ':' + m + ':' + s + '.' + ms;
        $(     'vm').value = ( $(     'iter').value / tempot ).toFixed(2);
        $(cor+'-vm').value = ( $(cor+'-iter').value / tempot ).toFixed(2);
        if ( antes !== undefined )
      {
        $(     'vi').value = (                    1 / tempoi ).toFixed(2);
        $(cor+'-vi').value = (                    1 / tempoi ).toFixed(2);
      }

        antes = agora;

        for ( var c=0; c<N; c++ )
        {
          cor = cores[c];
          $(cor+'-porc').value = ( 100 * $(cor+'-iter').value / $('iter').value ).toFixed(2) + '%';
        }

        if ($('rapido').checked)
           switch (intmeth)
           {
              case 1:
                setZeroTimeout(mainloop);
                break;
              case 2:
                setTimeout(mainloop,0);
                break;
           }
        else
           setTimeout(mainloop,delay);
      }

    }



    function rodar(enterloop)
    {

      if ( inicio === undefined && enterloop || rodando )
      {
          inicio = new Date();
        reinicio = inicio;
        $('inicio').value = inicio.date();
      }
      else
      {
        reinicio = new Date();
      }

      if (enterloop)
      {
        rodando = true;
        mainloop();
      }

    }



    function parar()
    {
      offset  = tempot;
      rodando = false;
    }



    function ponto(canvasid, x, y, cor)
    {

      // <http://jsperf.com/setting-canvas-pixel>

      cor = colornames[cor];

      switch (int($('plotmeth').value))
      {

        case 1:
          disco(canvasid, x, y, .5, 'rgba(' + cor[0] + ',' + cor[1] + ',' + cor[2] + ',255)');
          break;

        case 2:
          var idx     = ( x2col(x) + y2lin(y)*enatW )*4;
          var dataset = context[canvasid].getImageData(0, 0, enatW, enatH);
          dataset.data[idx+0] = cor[0];
          dataset.data[idx+1] = cor[1];
          dataset.data[idx+2] = cor[2];
          dataset.data[idx+3] = 255;
          context[canvasid].putImageData(dataset, 0, 0);
          break;

        case 3:
          context[canvasid].fillStyle = 'rgba(' + cor[0] + ',' + cor[1] + ',' + cor[2] + ',255)';
          context[canvasid].fillRect(x2col(x), y2lin(y), 1, 1);
          break;

        case 4:
          pixel[canvasid].data[0] = cor[0];
          pixel[canvasid].data[1] = cor[1];
          pixel[canvasid].data[2] = cor[2];
          pixel[canvasid].data[3] = 255;
          context[canvasid].putImageData(pixel[canvasid], x2col(x), y2lin(y));
          break;

      }

    }



    function disco(canvasid, cx, cy, raio, cor)
    {
      context[canvasid].beginPath();
      context[canvasid].fillStyle = cor;
      context[canvasid].arc(x2col(cx), y2lin(cy), raio, 0, 2*pi, false);
      context[canvasid].fill();
    }



    function linha(canvasid, x0, y0, x1, y1, espessura, cor)
    {
      context[canvasid].beginPath();
      context[canvasid].strokeStyle = cor;
      context[canvasid].lineWidth = espessura;
      context[canvasid].moveTo(x2col(x0), y2lin(y0));
      context[canvasid].lineTo(x2col(x1), y2lin(y1));
      context[canvasid].stroke();
    }



    Date.prototype.date = function()
    {
      var Y =      this.getFullYear ();
      var m =   (1+this.getMonth    ()).zpad();
      var d =      this.getDate     ().zpad();
      var a = week[this.getDay      ()];
      var H =      this.getHours    ().zpad();
      var M =      this.getMinutes  ().zpad();
      var S =      this.getSeconds  ().zpad();
      return Y + '/' + m + '/' + d + ' ' + a + ' ' + H + ':' + M + ':' + S;
    }



    String.prototype.lpad = function(padString, length)
    {
      var str = this;
      while (str.length < length) str = padString + str;
      return str;
    }



    Number.prototype.zpad = function() { return String(this).lpad('0',2) }

    function x2col(x) { return Math.round( natO[0] + x/sc ) }
    function y2lin(y) { return Math.round( natO[1] - y/sc ) }

    function sqr(n) { return Math.sqrt(n)    }
    function int(n) { return parseInt(n)     }
    function rnd(n) { return n*Math.random() }
    function sen(n) { return Math.sin(n)     }
    function cos(n) { return Math.cos(n)     }

    function $   (id)       { return document.getElementById(id) }
    function L   (varname)  { console.log( varname === undefined ? '' : varname + ' = ' + eval(varname) ) }
    function save(canvasid) { location = $(canvasid).toDataURL('image/png').replace('image/png','image/octet-stream') }



    function set(type, obj)
    {

      var c, arr, suf, sum, id, p, ids, i;

      switch (type)
      {

        case 'all' :
          for ( c=0; c<valor['N']; c++ )
          {
            var cor = cores[c];
            var id  = cor + '-' + obj.id;
            $(id).checked = obj.checked;
            $('canvas-'+id).style.visibility = obj.checked ? 'visible' : 'hidden';
          }
          break;

        case 'vis' :
          $('canvas-'+obj.id).style.visibility = obj.checked ? 'visible' : 'hidden';
          arr = obj.id.split('-');
          if (arr.length > 1)
          {
            arr.shift();
            suf = arr.join('-');
            sum = 0;
            for ( c=0; c<valor['N']; c++ ) sum += $(cores[c] + '-' + suf).checked;
            $(suf).checked = sum==valor['N'];
          }
          break;

        case 'bin' :
          id  = obj.id;
          p   = parametros[id];
          ids = Object.keys(p);
          i   = ids.indexOf(obj.value);
          obj.value = ids[(i+1)%2];
          if (typeof p[ids[(i+1)%2]] === 'function') p[ids[i]]();
          else                           valor[id] = p[ids[i]];
          break;

      }

    }



    // setZeroTimeout <http://dbaron.org/log/20100309-faster-timeouts>
    (

      // add only to the window object, and hide everything else in a closure.

      function()
      {

        var timeouts = [];
        var messageName = "zero-timeout-message";

        // Like setTimeout, but only takes a function argument. There's no time argument
        // (always zero) and no arguments (you have to use a closure).
        function setZeroTimeout(fn)
        {
          timeouts.push(fn);
          window.postMessage(messageName, "*");
        }

        function handleMessage(event)
        {
          if (event.source == window && event.data == messageName)
          {
            event.stopPropagation();
            if (timeouts.length > 0)
            {
              var fn = timeouts.shift();
              fn();
            }
          }
        }

        window.addEventListener("message", handleMessage, true);

        // Add the one thing we want added to the window object.
        window.setZeroTimeout = setZeroTimeout;

      }

    )();



  </script>

</head>

<body>

  <div id="canvases">
    <canvas id="canvas-semente0"></canvas>
  </div>

  <div id="controle">

            <input type="button"   id="sobre"   value="O que é isso?"                  class="color"                               onclick="location='http://goo.gl/ZxOdFR'" />
            <input type="text"     id="tamanho" value=""                  title="largura × altura"             disabled="disabled"                                           />

            <select                id="N"                                 title="#vértices"                                        onchange="ambiente()"                      ><option>#vértices</option></select>

            <input type="text"     id="fator"   value="fator"             title="fator"                                            onchange="valor[this.id]=this.value"      />
            <input type="button"   id="demonst" value="Como o fator é calculado?"      class="color"                               onclick="location='http://goo.gl/g5Xbll'" />

            <select                id="rastro"                            title="#rastro"                                                                                     ><option value="0">#rastro</option></select>

      <span><input type="checkbox" id="rapido"                                                                                                                               /><label for="rapido" />Rápido</label></span>

            <select                id="intmeth"                           title="Método de Interrupção"                                                                       >
              <option value="0">Interrupção</option>
              <option value="1">setTimeout</option>
              <option value="2">setZeroTimeout</option>
            </select>

            <select                id="plotmeth"                          title="Método de plotagem de pixels"                                                                >
              <option value="0">Plotagem</option>
              <option value="1">arc R=0.5</option>
              <option value="2">getImageData</option>
              <option value="3">fillRect L=1</option>
              <option value="4">1x1imageData</option>
            </select>

            <input type="button"   id="estado"  value="Iniciar"                        class="color"           disabled="disabled" onclick="set('bin',this)"                 />
            <input type="button"   id="salvar"  value="Salvar"            title="Coloque nome e extensão (.png)"                   onclick="save('canvas-red-pontos-color')" />
            <input type="button"   id="outro"   value="Outro"                                                                      onclick="location=''"                     />

    <div id="realtime">

            <input type="text"     id="inicio"  value="Hora de Início"    title="Hora de Início"               disabled="disabled"                                           />
            <input type="text"     id="agora"   value="Agora"             title="Agora"                        disabled="disabled"                                           />
            <input type="text"     id="tempot"  value="Tempo em Execução" title="Tempo em Execução (h:m:s.ms)" disabled="disabled"                                           />

      <span><input type="checkbox" id="semente0"                                                                                   onclick="set('vis',this)"                 /><label for="semente0">Semente 0 </label></span>
      <span><input type="checkbox" id="sementei"                                                                                   onclick="set('vis',this)"                 /><label for="sementei">Semente i </label></span>
      <span><input type="checkbox" id="semanter"                                                                                   onclick="set('vis',this)"                 /><label for="semanter">Anteriores</label></span>
      <span><input type="checkbox" id="crastro"                                                                                    onclick="set('vis',this)"                 /><label for="crastro" >Rastro    </label></span>

      <div id="cabecalho">

        <span title="Vértices Coloridos"     ><label for="vertex-color">V</label><input type="checkbox" id="vertex-color" onclick="set('all',this)" /></span>
        <span title="Vértices Monocromáticos"><label for="vertex-monoc">v</label><input type="checkbox" id="vertex-monoc" onclick="set('all',this)" /></span>
        <span title="Pontos Coloridos"       ><label for="pontos-color">P</label><input type="checkbox" id="pontos-color" onclick="set('all',this)" /></span>
        <span title="Pontos Monocromáticos"  ><label for="pontos-monoc">p</label><input type="checkbox" id="pontos-monoc" onclick="set('all',this)" /></span>
        <span title="Discos Coloridos"       ><label for="discos-color">D</label><input type="checkbox" id="discos-color" onclick="set('all',this)" /></span>
        <span title="Discos Monocromáticos"  ><label for="discos-monoc">d</label><input type="checkbox" id="discos-monoc" onclick="set('all',this)" /></span>
        <span title="Linhas Coloridas"       ><label for="linhas-color">L</label><input type="checkbox" id="linhas-color" onclick="set('all',this)" /></span>
        <span title="Linhas Monocromáticas"  ><label for="linhas-monoc">l</label><input type="checkbox" id="linhas-monoc" onclick="set('all',this)" /></span>

            <input type="text" id="iter" value="#iterações" title="#iterações"                       disabled="disabled"            /><!--
         --><input type="text" id="vm"   value="Vm"         title="Velociddade média (iter/s)"       disabled="disabled" class="vm" /><!--
         --><input type="text" id="vi"   value="Vi"         title="Velociddade instantânea (iter/s)" disabled="disabled" class="vi" />

      </div>

    </div>

  </div>

</body>

</html>
